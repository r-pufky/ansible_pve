---
###############################################################################
# Add PVE Server to Cluster
###############################################################################
# Use 'pvecm' to create/add a machine to the cluster.
#
# Exit codes captured:
#   0: cluster detected/status
#   2: no cluster detected
#
# Reference:
# * https://pve.proxmox.com/pve-docs/pvecm.1.html
# * https://pve.proxmox.com/wiki/Cluster_Manager
# * https://r-pufky.github.io/docs/virtualization/hypervisors/pve/index.html#add-to-datacenter-cluster

# Use default or first available IP address of the target machine.
# Reference: https://medium.com/opsops/ansible-default-ipv4-is-not-what-you-think-edb8ab154b10
- name: 'Create cluster | set server connected ip'  # noqa name[template]
  ansible.builtin.set_fact:
    _pve_host_ip: '{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}'

- name: 'Create cluster | check server cluster status'  # noqa name[template]
  ansible.builtin.command: 'pvecm status'
  changed_when: false
  register: _cluster_check
  failed_when: _cluster_check.rc > 2

- name: 'Create cluster | flush handler states'  # noqa name[template]
  ansible.builtin.meta: flush_handlers

- name: 'Create cluster | create cluster'  # noqa name[template] no-changed-when
  ansible.builtin.command: 'pvecm create {{ pve_cluster_name }}'
  when: |
    _cluster_check.rc == 2 and
    _pve_host_ip == pve_master_node_ip

# expect: enter password, accept host fingerprints
- name: 'Create cluster | add to cluster'  # noqa name[template]
  ansible.builtin.expect:
    command: 'pvecm add {{ pve_master_node_ip }}'
    responses:
      'password for': '{{ pve_root_password }}'
      '(?i)fingerprint': 'yes'
    echo: true
    timeout: 60
  no_log: true # user password
  when: |
    _cluster_check.rc == 2 and
    _pve_host_ip != pve_master_node_ip and
    _pve_host_ip in pve_node_ips

- name: 'Create cluster | verify cluster created'  # noqa name[template]
  ansible.builtin.command: 'pvecm status'
  changed_when: false
  register: _cluster_verify
  failed_when: _cluster_verify.rc == 2
